# .github/workflows/price-update-scheduler.yml
# å¹³æ—¥æœ10æ™‚ï¼ˆJSTï¼‰ã«è‡ªå‹•ä¾¡æ ¼æ›´æ–°ã‚’å®Ÿè¡Œã™ã‚‹GitHub Actions

name: è‡ªå‹•ä¾¡æ ¼æ›´æ–°ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼

on:
  # å¹³æ—¥æœ1æ™‚ï¼ˆUTCï¼‰= æ—¥æœ¬æ™‚é–“æœ10æ™‚ã«å®Ÿè¡Œ
  schedule:
    - cron: '0 1 * * 1-5'  # æœˆæ›œæ—¥-é‡‘æ›œæ—¥ UTC 1:00
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      force_execution:
        description: 'å¼·åˆ¶å®Ÿè¡Œï¼ˆç¥æ—¥ã§ã‚‚å®Ÿè¡Œï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  price-update:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    env:
      CRON_ENDPOINT: ${{ secrets.CRON_ENDPOINT }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    steps:
      - name: ğŸ“… å®Ÿè¡Œæ™‚åˆ»ã‚’JSTã§è¡¨ç¤º
        run: |
          echo "ğŸ•™ å®Ÿè¡Œæ™‚åˆ»ï¼ˆUTCï¼‰: $(date -u)"
          echo "ğŸ•™ å®Ÿè¡Œæ™‚åˆ»ï¼ˆJSTï¼‰: $(TZ=Asia/Tokyo date)"
      
      - name: ğŸƒ è‡ªå‹•ä¾¡æ ¼æ›´æ–°ã‚’å®Ÿè¡Œ
        run: |
          echo "ğŸš€ ä¾¡æ ¼æ›´æ–°APIã‚’å‘¼ã³å‡ºã—ä¸­..."
          
          FORCE_PARAM=""
          if [ "${{ inputs.force_execution }}" = "true" ]; then
            FORCE_PARAM="?force=1"
          fi
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "x-vercel-cron: 1" \
            -H "Content-Type: application/json" \
            "$CRON_ENDPOINT$FORCE_PARAM")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "ğŸ“¡ HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $http_code"
          echo "ğŸ“„ ãƒ¬ã‚¹ãƒãƒ³ã‚¹: $body"
          
          if [ "$http_code" != "200" ]; then
            echo "âŒ ä¾¡æ ¼æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "$body"
            exit 1
          else
            echo "âœ… ä¾¡æ ¼æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ"
            echo "$body" | jq '.' || echo "$body"
          fi

      - name: ğŸ“Š å®Ÿè¡Œçµæœã‚’Slackã«é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if: always() && env.SLACK_WEBHOOK_URL != ''
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            emoji="âœ…"
            color="good"
            message="ä¾¡æ ¼è‡ªå‹•æ›´æ–°ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          else
            emoji="âŒ"
            color="danger"
            message="ä¾¡æ ¼è‡ªå‹•æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          fi
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$color\",
                \"title\": \"$emoji $message\",
                \"fields\": [
                  {\"title\": \"å®Ÿè¡Œæ™‚åˆ»\", \"value\": \"$(TZ=Asia/Tokyo date)\", \"short\": true},
                  {\"title\": \"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹\", \"value\": \"${{ job.status }}\", \"short\": true}
                ]
              }]
            }" \
            "$SLACK_WEBHOOK_URL"